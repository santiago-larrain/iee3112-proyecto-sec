name: Notify Teams via Flow

on:
  issues:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch: {}

permissions:
  contents: read
  issues: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build Adaptive Card payload
        run: |
          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          TITLE=""
          SUB=""
          URL=""

          if [ "$EVENT" = "issues" ]; then
            NUM="${{ github.event.issue.number }}"
            TITLE="ðŸ”” Issue #${NUM} ${ACTION}"
            SUB="${{ github.event.issue.title }}"
            URL="${{ github.event.issue.html_url }}"
          else
            NUM="${{ github.event.issue.number }}"
            TITLE="ðŸ’¬ Comment ${ACTION} on issue #${NUM}"
            BODY="$(printf '%.300s' "${{ github.event.comment.body }}" )"
            SUB="${{ github.event.comment.user.login }}: $BODY"
            URL="${{ github.event.issue.html_url }}"
          fi

          cat > payload.json <<EOF
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "type": "AdaptiveCard",
                  "version": "1.5",
                  "body": [
                    { "type": "TextBlock", "weight": "Bolder", "size": "Medium", "text": "$TITLE" },
                    { "type": "TextBlock", "wrap": true, "text": "$SUB" }
                  ],
                  "actions": [
                    { "type": "Action.OpenUrl", "title": "Ver en GitHub", "url": "$URL" }
                  ]
                }
              }
            ]
          }
          EOF

      - name: Send to Teams
        env:
          HOOK: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          curl -sS -X POST "$HOOK" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
